pipeline {
    agent any

    environment {
        TOKEN = ""
    }

    stages {
        stage('Authentification Xray') {
            steps {
                script {
                    echo "G√©n√©ration d'un token dynamique..."
                    def response = bat(script: """
                        curl -s -H "Content-Type: application/json" -X POST --data "{\\"client_id\\":\\"${params.XRAY_CLIENT_ID}\\",\\"client_secret\\":\\"${params.XRAY_CLIENT_SECRET}\\"}" https://xray.cloud.getxray.app/api/v2/authenticate
                    """, returnStdout: true).trim()
                    
                    env.TOKEN = response.split('\r\n')[-1].replaceAll('"', '')
                    echo "Token g√©n√©r√© avec succ√®s."
                }
            }
        }

        stage('Build & Test') {
             steps {
                echo 'Ex√©cution des tests Robot Framework...'
                bat 'robot -d results testCases/'
             }
        }
    }

    post {
        always {
            echo "Import vers Xray..."
            bat  'curl -H "Content-Type: text/xml" -X POST -H "Authorization: Bearer %TOKEN%"  --data @"results/output.xml" https://xray.cloud.getxray.app/api/v2/import/execution/robot?projectKey=POEI2'
        }
        success { echo 'Pipeline termin√© avec succ√®s üéâ' }
        failure { echo '√âchec du pipeline ‚ùå' }
    }
}